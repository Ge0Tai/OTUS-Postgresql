### Домашнее задание № 7 (Блокировки PostgreSQL)

1. Подготовим к домашнему заданию новую БД - <b>otus_lock</b>.

Справочная информация о блокировках:

### pg_locks - (представление) текущие блокировки в БД
 - <b>relation</b>  
Блокировки отношений.

 - <b>transactionid</b> и <b>virtualxid</b>  
Блокировка номера транзакции (настоящего или виртуального). Каждая транзакция сама удерживает исключительную блокировку своего собственного номера, поэтому такие блокировки удобно использовать, когда нужно дождаться окончания другой транзакции.

 - <b>tuple</b>  
Блокировка версии строки. Используется в некоторых случаях для установки приоритета среди нескольких транзакций, ожидающих блокировку одной и той же строки.

 - <b>extend</b>  
Используется при добавлении страниц к файлу какого-либо отношения.

 - <b>object</b>  
Блокировка объектов, которые не являются отношениями (баз данных, схем, подписок и т. п.).

 - <b>page</b>  
Блокировка страницы, используется нечасто и только некоторыми типами индексов.

 - <b>advisory</b>  
Рекомендательная блокировка, устанавливается пользователем вручную.

#### Матрица совместимости блокировок:

![](pics/dz8/1_matrix_locks.PNG)

### pg_blocking_pids(<i>pid</i>) - (функция) кто блокирует
### log_lock_waits - (параметр)
### max_locks_per_transaction × max_connections - максимальное количество блокировок в системе

>Пул блокировок — общий для всех транзакций, то есть одна транзакция может захватить больше блокировок, чем max_locks_per_transaction: важно лишь, чтобы общее число блокировок в системе не превысило установленный предел. Пул создается при запуске, так что <b>изменение любого из двух указанных параметров требует перезагрузки сервера</b>.

2. Настроим параметры:

![](pics/dz8/1_set_params_deadlocks.PNG)

Создадим вью <b>v_locks</b>:

 `CREATE VIEW v_locks AS`  
 `SELECT pid,`  
       `locktype,`  
       `CASE locktype`  
         `WHEN 'relation' THEN relation::REGCLASS::text`  
         `WHEN 'virtualxid' THEN virtualxid::text`  
         `WHEN 'transactionid' THEN transactionid::text`  
         `WHEN 'tuple' THEN relation::REGCLASS::text||':'||tuple::text`  
       `END AS lockid,`  
       `mode,`  
       `granted`  
 `FROM pg_locks;`
 
 ![](pics/dz8/2_cr_view_locks.PNG)
 
 Обратимся к нашему вью и увидим следующие блокировки (для каждого сеанса, в данном случае, одинаковые, т.к. происходит только чтение:

 ![](pics/dz8/2_sel_v_locks.PNG)
